{% extends "layout.html" %}

{% block title %}
    Register
{% endblock %}

{% block main %}
<h1 class="center title" style="margin-top: 5%; margin-bottom: 5%;">Register</h1>

<form id="my_form" action="/register" method="post" onsubmit="check()">
  <div class="form-group row">
    <label for="username" class="col-sm-2 col-form-label">Username</label>
    <div class="col-sm-10">
      <div id="alert-username" class="invalid-feedback" style="display:none;">
        Username already taken!
      </div>
      <input type="text" id="username" class="form-control" name="username" placeholder="Type your desired username here">
    </div>
  </div>

  <div class="form-group row">
    <label for="inputpassword" class="col-sm-2 col-form-label">Password</label>
    <div class="col-sm-10">
      <div id="alert-password" class="invalid-feedback" style="display:none;">
          Your password must be 6-20 characters long, must contain one or more numbers and must not contain spaces.
      </div>
      <input type="password" id="inputpassword" class="form-control" name="password" placeholder="Choose a password">
    </div>
  </div>


  <div class="form-group row">
    <label for="confirmpassword" class="col-sm-2 col-form-label">Confirm password</label>
    <div class="col-sm-10">
      <div id="alert-confirmation" class="invalid-feedback" style="display:none;">
        Your password confirmation must match your password!
      </div>
      <input type="password" id="confirmpassword" class="form-control" name="confirmation" placeholder="Retype the above password">
    </div>
  </div>
  <button type="submit" class="btn btn-lg">Register</button>
</form>

    <script>
        document.getElementById("my_form").addEventListener("submit", function(event){
        event.preventDefault();
        document.getElementById("alert-username").style.display = "none";
        document.getElementById("username").className = "form-control";
        document.getElementById("alert-password").style.display = "none";
        document.getElementById("inputpassword").className = "form-control";
        document.getElementById("alert-confirmation").style.display = "none";
        document.getElementById("confirmpassword").className = "form-control";
        });

        function check() {
            var my_form = document.querySelector("form");
            var username = document.querySelector("input[name='username']");
            var password = document.querySelector("input[name='password']");
            var confirm = document.querySelector("input[name='confirmation']");

            var user_check = $.get("/check?username=" + username.value, function(available) {
                var availability = $.parseJSON(available);
                if (availability == false) {
                    document.getElementById("alert-username").style.display = "block";
                    document.getElementById("username").className = "form-control is-invalid";
                    my_form.reset();
                }
            });
            var pass_check = $.post("/check", {password: password.value, confirmation: confirm.value}, function(correctness) {
                if (correctness.succes == false) {
                    document.getElementById("alert-password").style.display = "block";
                    document.getElementById("inputpassword").className = "form-control is-invalid";
                    my_form.reset();
                }

                if (correctness.confirmation == false) {
                    document.getElementById("alert-confirmation").style.display = "block";
                    document.getElementById("confirmpassword").className = "form-control is-invalid";
                    my_form.reset();
                }
            });
            user_check.done(function(availability) {
                pass_check.done(function(correctness) {
                    if (availability == true && correctness.succes == true && correctness.confirmation == true) {
                        my_form.submit();
                    }
                });
            });
        }
    </script>
{% endblock %}